<div class="event-container">
  <!-- Messages -->
  <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>
  <div *ngIf="successMessage" class="success">{{ successMessage }}</div>

  <!-- Action Bar -->
  <div class="action-bar" *ngIf="!isCreating && !isEditing">
    <div class="filter-controls">
      <div class="filter-group">
        <label>Filter by Type:</label>
        <select [(ngModel)]="filterType" class="filter-select">
          <option value="all">All Events</option>
          <option *ngFor="let type of getUniqueTypes()" [value]="type">{{ type }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Filter by Status:</label>
        <select [(ngModel)]="filterProcessed" class="filter-select">
          <option value="all">All Status</option>
          <option value="true">Processed</option>
          <option value="false">Unprocessed</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" (click)="showCreateForm()">+ Add New Event</button>
  </div>

  <!-- Create Form -->
  <div *ngIf="isCreating" class="form-card">
    <h2>Create New Event</h2>
    <form (ngSubmit)="createEvent()">
      <div class="form-row">
        <div class="form-group">
          <label>Type *</label>
          <select [(ngModel)]="newEvent.type" name="type" required class="form-select">
            <option value="">Select Type</option>
            <option value="wan_lost">wan_lost</option>
            <option value="wan_disconnected">wan_disconnected</option>
            <option value="wan_restored">wan_restored</option>
            <option value="dhcp_renewed">dhcp_renewed</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date & Time *</label>
          <input type="datetime-local" [(ngModel)]="newEvent.date" name="date" required>
        </div>
      </div>

      <div class="form-section-title">Device Information</div>
      <div class="form-row">
        <div class="form-group">
          <label>MAC Address</label>
          <input type="text" [(ngModel)]="newEvent.macAddress" name="macAddress" placeholder="00:00:00:00:00:00">
        </div>
        <div class="form-group">
          <label>Serial</label>
          <input type="text" [(ngModel)]="newEvent.serial" name="serial">
        </div>
      </div>

      <div class="form-section-title">Event Details</div>
      <div class="form-group">
        <label>Message</label>
        <textarea [(ngModel)]="newEvent.message" name="message" rows="3" placeholder="Event message or description"></textarea>
      </div>

      <div class="form-group">
        <label>Payload (JSON String)</label>
        <textarea [(ngModel)]="newEvent.payload" name="payload" rows="4" placeholder='{"key": "value"} (optional)'></textarea>
        <small class="help-text">Enter JSON string or any text payload (stored as BLOB in database)</small>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Event</button>
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Edit Form -->
  <div *ngIf="isEditing && selectedEvent" class="form-card">
    <h2>Edit Event</h2>
    <form (ngSubmit)="updateEvent()">
      <div class="form-row">
        <div class="form-group">
          <label>Type *</label>
          <select [(ngModel)]="selectedEvent.type" name="type" required class="form-select">
            <option value="">Select Type</option>
            <option value="wan_lost">wan_lost</option>
            <option value="wan_disconnected">wan_disconnected</option>
            <option value="wan_restored">wan_restored</option>
            <option value="dhcp_renewed">dhcp_renewed</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date & Time *</label>
          <input type="datetime-local" [(ngModel)]="selectedEvent.date" name="date" required>
        </div>
      </div>

      <div class="form-section-title">Device Information</div>
      <div class="form-row">
        <div class="form-group">
          <label>MAC Address</label>
          <input type="text" [(ngModel)]="selectedEvent.macAddress" name="macAddress" placeholder="00:00:00:00:00:00">
        </div>
        <div class="form-group">
          <label>Serial</label>
          <input type="text" [(ngModel)]="selectedEvent.serial" name="serial">
        </div>
      </div>

      <div class="form-section-title">Event Details</div>
      <div class="form-group">
        <label>Message</label>
        <textarea [(ngModel)]="selectedEvent.message" name="message" rows="3" placeholder="Event message or description"></textarea>
      </div>

      <div class="form-group">
        <label>Payload (JSON String)</label>
        <textarea [(ngModel)]="selectedEvent.payload" name="payload" rows="4" placeholder='{"key": "value"} (optional)'></textarea>
        <small class="help-text">Enter JSON string or any text payload (stored as BLOB in database)</small>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Update Event</button>
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">Loading events...</div>

  <!-- Events List -->
  <div *ngIf="!loading && !isCreating && !isEditing" class="events-grid">
    <div *ngFor="let event of getFilteredEvents()" class="card event-card">
      <div class="event-header">
        <div class="event-title">
          <span *ngIf="event.type" class="type-badge" [class]="'type-' + event.type?.toLowerCase()">
            {{ event.type }}
          </span>
          <span class="event-date">{{ event.date | date:'short' }}</span>
        </div>
        <span class="processed-badge" [class.processed]="event.processed" [class.unprocessed]="!event.processed">
          {{ event.processed ? '✓ Processed' : '⏳ Pending' }}
        </span>
      </div>

      <div class="event-details">
        <div *ngIf="event.message" class="event-message">
          {{ event.message }}
        </div>

        <div *ngIf="event.macAddress || event.serial" class="device-info">
          <div class="info-row" *ngIf="event.macAddress">
            <span class="label">MAC:</span>
            <span class="value">{{ event.macAddress }}</span>
          </div>
          <div class="info-row" *ngIf="event.serial">
            <span class="label">Serial:</span>
            <span class="value">{{ event.serial }}</span>
          </div>
        </div>

        <div *ngIf="event.payload && event.payload.length > 0" class="payload-info">
          <span class="label">Payload:</span>
          <span class="payload-size">{{ event.payload.length }} chars</span>
          <button class="btn-link" (click)="viewPayloadDetails(event.payload)">View</button>
        </div>
      </div>

      <div class="card-actions">
        <button class="btn btn-primary btn-sm" (click)="editEvent(event)">Edit</button>
        <button class="btn btn-danger btn-sm" (click)="deleteEvent(event.eventId)">Delete</button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !isCreating && !isEditing && getFilteredEvents().length === 0" class="empty-state">
    <p>No events found. Create your first event!</p>
  </div>

  <!-- Payload Viewer Modal -->
  <div *ngIf="viewPayload" class="modal-overlay" (click)="closePayloadView()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Payload Data</h3>
        <button class="close-btn" (click)="closePayloadView()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="payload-display">
          <h4>Payload Content:</h4>
          <pre class="payload-code">{{ viewPayload }}</pre>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closePayloadView()">Close</button>
      </div>
    </div>
  </div>
</div>

